<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
    <title>Test coverage report: frontend.views</title>
    <style type="text/css" media="screen">
      a
      {
        color: #3d707a;
      }
      
      a:hover, a:active
      {
        color: #bf7d18;
      }
    
      body 
      {
        font-family: "Lucida Sans Unicode", "Lucida Grande", sans-serif;
        font-size: 13px;
      }
      
      .nav 
      {
        font-size: 12px;
        margin-left: 50px;
      }

      .ignored
      {
        color: #707070;
      }

      .executed 
      {
        color: #3d9900;
      }

      .missed 
      {
        color: red;
        font-weight: bold;
      }

      .excluded 
      {
        color: #6090f0;
        font-weight: lighter;
      }
    
      #content-header 
      {
        font-size: 12px;
        padding: 18px 0 18px 50px;
      }

      #content-header h1 
      {
        font-size: 16px;
        margin: 10px 0 0 0;
        color: #909090;
      }
      
      #module-name
      {
        color: #583707;
      }
    
      #content-header p
      {
        font-size: 13px;
        margin: 0;
        color: #909090;
      }

      #content-header .normal 
      {
        color: #609030;
      }

      #content-header .warning 
      {
        color: #d0a000;
      }

      #content-header .critical 
      {
        color: red;
      }
      
      #source-listing 
      {
        margin-bottom: 24px;
      }

      #source-listing ol 
      {
        padding: 0 0 0 50px;
        width: 90%;
        font-family: monospace;
        list-style-position: outside;
      }

      #source-listing ol li 
      {
        line-height: 18px;
        font-size: small;
      }
        
      #source-listing ol code 
      {
        padding:  0 .001em 0 0; /* Firefox doesn't render empty li's properly */
        font-size: medium;
        white-space: pre;
      }
   </style>
  </head>

  <body>

<div class="nav">
  <a href="frontend.templatetags.cut.html">frontend.templatetags.cut</a> &lt;&lt;
  <a href="../index.html">index</a>
  &gt;&gt; <a href="frontend.widgets.html">frontend.widgets</a>
</div>

<div id="content-header">
  <h1>
    <span id="module-name">frontend.views</span>:
    331 total statements,
    <span class="critical">0.0% covered</span>
  </h1>
  <p>Generated: Thu 2013-10-31 23:47 VLAT</p>
  <p>Source file: /srv/www/photoplus/frontend/views.py</p>
  <p>
    Stats:
    <span class="executed">0 executed</span>,
    <span class="missed">305 missed</span>,
    <span class="excluded">26 excluded</span>,
    <span class="ignored">190 ignored</span> 
  </p> 
</div>

<div id="source-listing">
  <ol>
    <li class="excluded"><code>from django.http         import Http404</code></li>
<li class="excluded"><code>from django.shortcuts    import render_to_response</code></li>
<li class="excluded"><code>from django.template     import Context, loader, Template</code></li>
<li class="excluded"><code>from django.http         import HttpResponse</code></li>
<li class="excluded"><code>from apiclient.discovery import build</code></li>
<li class="excluded"><code>from frontend.models     import *</code></li>
<li class="excluded"><code>from sys                 import *</code></li>
<li class="excluded"><code>from math                import *</code></li>
<li class="excluded"><code>from django.core.mail      import send_mail</code></li>
<li class="excluded"><code>from django.template       import RequestContext</code></li>
<li class="excluded"><code>from django.http      import HttpResponseRedirect</code></li>
<li class="excluded"><code>from frontend.forms       import ReCaptchaForm</code></li>
<li class="excluded"><code>from frontend.forms       import buyForm</code></li>
<li class="excluded"><code>from frontend.models      import *</code></li>
<li class="excluded"><code>from django.core.mail      import EmailMultiAlternatives</code></li>
<li class="excluded"><code>from django.core.mail      import EmailMessage</code></li>
<li class="excluded"><code>from django.conf      import settings</code></li>
<li class="excluded"><code>from email.MIMEImage      import MIMEImage</code></li>
<li class="excluded"><code>from django          import template</code></li>
<li class="excluded"><code>from config             import ACCOUNT_ID,ACCOUNT_EMAIL, ACCOUNT_PASSWORD, BEST_PHOTO_ALBUM</code></li>
<li class="excluded"><code>import gdata.photos.service</code></li>
<li class="excluded"><code>#import gdata.media</code></li>
<li class="excluded"><code>#import gdata.geo</code></li>
<li class="excluded"><code>import cgi</code></li>
<li class="excluded"><code>import datetime</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="excluded"><code>import sys, traceback</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>LAST_VISIT_TO_ACCOUNT = 0</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code># Parsing tag info</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code># in : string with hashtags</code></li>
<li class="ignored"><code># out: list of tags( strings )</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>def get_tags_list( hashstring ):</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    hashstring = hashstring.replace("&amp;#","")</code></li>
<li class="missed"><code>    tags_list = []</code></li>
<li class="missed"><code>    for e in range( 0,hashstring.count("ot-hashtag") ):</code></li>
<li class="missed"><code>        r = hashstring.find('#')+1</code></li>
<li class="missed"><code>        hashstring = hashstring[r:]</code></li>
<li class="missed"><code>        t = hashstring.find('&lt;')</code></li>
<li class="missed"><code>        tags_list.append( hashstring[:t] )</code></li>
<li class="missed"><code>    return tags_list</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code># Extracting data from</code></li>
<li class="ignored"><code># personal account of Yuri Vashchenko</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code># in : ---</code></li>
<li class="ignored"><code># out: list of structures like ---&gt; [ url , [ #1_ht , #2_ht , ..</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code># ! Important: single use of this function spares 1 / 10.000 of API request !</code></li>
<li class="missed"><code>def api_data_extraction():</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    service = build(     'plus',</code></li>
<li class="ignored"><code>                         'v1',</code></li>
<li class="ignored"><code>    developerKey =       'AIzaSyAKCO6eEQHQLN32ZARi2TOoJXVP88EZW4c')</code></li>
<li class="missed"><code>    activities_resource = service.activities()</code></li>
<li class="missed"><code>    request = activities_resource.list(</code></li>
<li class="ignored"><code>    userId =             ACCOUNT_ID,                                               #100915540970866628562,'103582189468795743999',</code></li>
<li class="ignored"><code>    collection =         'public',</code></li>
<li class="ignored"><code>    maxResults =         '100' )</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    act_list = []</code></li>
<li class="missed"><code>    activities_document = request.execute()</code></li>
<li class="missed"><code>    if 'items' in activities_document:</code></li>
<li class="missed"><code>        for activity in activities_document['items']:                                           # taking every activity</code></li>
<li class="missed"><code>            if 'actor' not in activity['object']:                                               # if activity is not reshared</code></li>
<li class="missed"><code>                if 'attachments' in activity['object']:                                         # if activity has attachments</code></li>
<li class="missed"><code>                    if activity['object']['attachments'][0]['objectType'] == "photo":           # if activity type is photo</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>                        act_struct = []                                                         # [ url , [ #1_ht , #2_ht , ... ] ]</code></li>
<li class="missed"><code>                        act_struct.append( activity['object']['attachments'][0]['fullImage']['url'] )</code></li>
<li class="missed"><code>                        act_struct.append( activity['updated'] )</code></li>
<li class="missed"><code>                        act_struct.append( activity['url'] )</code></li>
<li class="missed"><code>                        act_struct.append( strip_title( activity['object']['content'][:40] ) )</code></li>
<li class="missed"><code>                        act_struct.append( get_tags_list( activity['object']['content'] ) )</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>                        act_list.append( act_struct )</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    return act_list</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>def refresh_db_with_new_data( ):</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    new_data = api_data_extraction()</code></li>
<li class="missed"><code>    posts_list = []</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    for el in Post.objects.all():</code></li>
<li class="missed"><code>        posts_list.append( el.image_url )</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    for element in new_data:</code></li>
<li class="missed"><code>        if element[0] not in posts_list:</code></li>
<li class="missed"><code>            p = Post( image_url = element[0] , renew = element[1] , post_url = element[2] , post_title = element[3] )</code></li>
<li class="missed"><code>            p.save()</code></li>
<li class="ignored"><code>        else:</code></li>
<li class="missed"><code>            p = Post.objects.get( image_url = element[0] )</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        if len(element) == 5:</code></li>
<li class="missed"><code>            tags_list = []</code></li>
<li class="missed"><code>            for el in Tag.objects.all():</code></li>
<li class="missed"><code>                tags_list.append( el.name )</code></li>
<li class="missed"><code>            for tag in element[4]:</code></li>
<li class="missed"><code>                if tag not in tags_list:</code></li>
<li class="missed"><code>                    t = Tag ( name = tag )</code></li>
<li class="missed"><code>                    t.save()</code></li>
<li class="missed"><code>                    t.posts.add(p)</code></li>
<li class="missed"><code>                    t.save()</code></li>
<li class="ignored"><code>                else:</code></li>
<li class="missed"><code>                    t = Tag.objects.filter( name = tag )[0]</code></li>
<li class="missed"><code>                    t.posts.add(p)</code></li>
<li class="missed"><code>                    t.save()</code></li>
<li class="missed"><code>    return</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>def clear_db( ):</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    p = Post.objects.all()</code></li>
<li class="missed"><code>    t = Tag.objects.all()</code></li>
<li class="missed"><code>    p.clear()</code></li>
<li class="missed"><code>    t.clear()</code></li>
<li class="missed"><code>    return</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>def contact(request):</code></li>
<li class="missed"><code>    al = Album.objects.all()</code></li>
<li class="missed"><code>    a = Author.objects.get(id=1)</code></li>
<li class="missed"><code>    form = ReCaptchaForm()</code></li>
<li class="missed"><code>    if request.POST:</code></li>
<li class="missed"><code>        form = ReCaptchaForm(request.POST)</code></li>
<li class="missed"><code>        if form.is_valid():</code></li>
<li class="missed"><code>            cd = form.cleaned_data</code></li>
<li class="missed"><code>            send_mail(</code></li>
<li class="ignored"><code>                cd['subject'],</code></li>
<li class="ignored"><code>                cd['message'],</code></li>
<li class="ignored"><code>                cd.get('email', a.email), [a.email], fail_silently=False</code></li>
<li class="ignored"><code>                    )</code></li>
<li class="missed"><code>            return HttpResponseRedirect('/about/')</code></li>
<li class="ignored"><code>    else:</code></li>
<li class="missed"><code>        form = ReCaptchaForm(  initial={'subject': 'I love your site!'}</code></li>
<li class="ignored"><code>                 )</code></li>
<li class="missed"><code>    return render_to_response('contact.html', {'form': form, 'album_list':al}, context_instance=RequestContext(request))</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>def buy(request, idP, resolution):</code></li>
<li class="missed"><code>    try:</code></li>
<li class="missed"><code>        al = Album.objects.all()</code></li>
<li class="missed"><code>        a = Message.objects.get(id=1)</code></li>
<li class="missed"><code>        pr = Price.objects.get( id = resolution)</code></li>
<li class="missed"><code>        al = Album.objects.all()</code></li>
<li class="missed"><code>        a = Message.objects.get(id=1)</code></li>
<li class="missed"><code>        pr = Price.objects.get( id = resolution)</code></li>
<li class="missed"><code>        idP = int(idP)</code></li>
<li class="missed"><code>        photo_id = Post.objects.get( id = idP )</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    except Post.DoesNotExist:</code></li>
<li class="missed"><code>        raise Http404</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    t_to = Template(a.information_to) #to you</code></li>
<li class="missed"><code>    t_from = Template(a.information_from) #from you/ means from admin</code></li>
<li class="missed"><code>    s_to = Template(a.subject_to)</code></li>
<li class="missed"><code>    s_from = Template(a.subject_from)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    codepage = request.get_host()</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    form = buyForm()</code></li>
<li class="missed"><code>    if request.POST:</code></li>
<li class="missed"><code>        form = buyForm(request.POST)</code></li>
<li class="missed"><code>        if form.is_valid():</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>            cd = form.cleaned_data</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>            subject_to = a.subject_to</code></li>
<li class="missed"><code>            email_from = a.email</code></li>
<li class="missed"><code>            email_to = cd['Email']</code></li>
<li class="missed"><code>            country = cd['Country']</code></li>
<li class="missed"><code>            street1 = cd['Address1']</code></li>
<li class="missed"><code>            street2 = cd['Address2']</code></li>
<li class="missed"><code>            city = cd['City']</code></li>
<li class="missed"><code>            state = cd['State']</code></li>
<li class="missed"><code>            zip_code = cd['Index']</code></li>
<li class="missed"><code>            f_name = cd['FirstName']</code></li>
<li class="missed"><code>            l_name = cd['LastName']</code></li>
<li class="missed"><code>            price = pr.price</code></li>
<li class="missed"><code>            size = str(pr.size) + u"*" + str(pr.on)</code></li>
<li class="missed"><code>            post_title = photo_id.post_title</code></li>
<li class="missed"><code>            image_url =  photo_id.image_url</code></li>
<li class="missed"><code>            post_url =  photo_id.post_url</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>            order = Order(name= l_name + u" " + f_name,</code></li>
<li class="ignored"><code>              adress = street1 + u", " + street2 + u", " + city + u", " + state + u", " + country + u", " + zip_code,</code></li>
<li class="ignored"><code>              photo_id = image_url,</code></li>
<li class="ignored"><code>              price = price,</code></li>
<li class="ignored"><code>              size = size,</code></li>
<li class="ignored"><code>              status = 'RECEIVED'</code></li>
<li class="ignored"><code>            )</code></li>
<li class="missed"><code>            order.save()</code></li>
<li class="missed"><code>            idorder = order.id</code></li>
<li class="missed"><code>            orderref = codepage + u'/order/' +   str(idorder) + u'/'</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>            c = Context({"f_name": f_name, "l_name": l_name, "country": country, "street1": street1, "street2": street2, "city":city, "state": state,  "zip_code": zip_code, "price": price, "size": size, "post_title":post_title, "image_url":image_url, "post_url": post_url, "orderref": orderref, "idorder": idorder })</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>            message_from = t_from.render(c)</code></li>
<li class="missed"><code>            subjectmessage_from = s_from.render(c)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>            message_to = t_to.render(c)</code></li>
<li class="missed"><code>            subjectmessage_to = s_to.render(c)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>            msg_from= EmailMessage(subjectmessage_from, message_from, email_from, [email_to])</code></li>
<li class="missed"><code>            msg_from.content_subtype = "html"  # Main content is now text/html</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>            msg_from.send()</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>            msg_to = EmailMessage(subjectmessage_to, message_to, email_from, [email_from])</code></li>
<li class="missed"><code>            msg_to.content_subtype = "html"  # Main content is now text/html</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>            msg_to.send()</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        return HttpResponseRedirect('/preview/' + str(idP))</code></li>
<li class="ignored"><code>    else:</code></li>
<li class="missed"><code>        form = buyForm()</code></li>
<li class="missed"><code>    return render_to_response('buy.html', {'form': form, 'buy':a, 'album_list':al }, context_instance=RequestContext(request))</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>#--------------------------------------------------------------------------------------------------</code></li>
<li class="ignored"><code>#                                          ABOUT</code></li>
<li class="ignored"><code>#--------------------------------------------------------------------------------------------------</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>def about(request):</code></li>
<li class="missed"><code>    try:</code></li>
<li class="missed"><code>        a = Author.objects.get(id=1)</code></li>
<li class="missed"><code>        al = Album.objects.all()</code></li>
<li class="missed"><code>    except Post.DoesNotExist:</code></li>
<li class="missed"><code>        raise Http404</code></li>
<li class="missed"><code>    return render_to_response('about.html',{ 'about':a , 'album_list':al })</code></li>
<li class="ignored"><code>#--------------------------------------------------------------------------------------------------</code></li>
<li class="ignored"><code>#                                          PREVIEW</code></li>
<li class="ignored"><code>#--------------------------------------------------------------------------------------------------</code></li>
<li class="missed"><code>def preview(request, idP ):</code></li>
<li class="missed"><code>    try:</code></li>
<li class="ignored"><code>        #album = Album.objects.get( name = idA)</code></li>
<li class="missed"><code>        idP = int(idP)</code></li>
<li class="missed"><code>        photo = Post.objects.get( id = idP )</code></li>
<li class="missed"><code>        al = Album.objects.all()</code></li>
<li class="missed"><code>        prices = Price.objects.all()</code></li>
<li class="missed"><code>    except Post.DoesNotExist:</code></li>
<li class="missed"><code>        raise Http404</code></li>
<li class="missed"><code>    return render_to_response('preview.html',{ 'photo':photo , 'album':album, 'album_list':al, 'prices':prices })</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>def preview_best(request, photoId):</code></li>
<li class="missed"><code>    try:</code></li>
<li class="missed"><code>        photoId = int(photoId)</code></li>
<li class="missed"><code>        photo = BestPhoto.objects.get( id = photoId )</code></li>
<li class="missed"><code>        al = Album.objects.all()</code></li>
<li class="missed"><code>        prices = Price.objects.all()</code></li>
<li class="missed"><code>    except Post.DoesNotExist:</code></li>
<li class="missed"><code>        raise Http404</code></li>
<li class="missed"><code>    photo_url = 'https://plus.google.com/u/0/photos/'+ACCOUNT_ID+'/albums/'+BestAlbum.objects.get( id = 1 ).album_id+'/'+photo.image_id</code></li>
<li class="ignored"><code>   # raise Exception, photo_url</code></li>
<li class="missed"><code>    return render_to_response('preview.html',{ 'photo':photo ,'gurl': photo_url,'album':album, 'album_list':al, 'prices':prices })</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>#--------------------------------------------------------------------------------------------------</code></li>
<li class="ignored"><code>#                                      GET_PAGINATOR_DATA</code></li>
<li class="ignored"><code>#--------------------------------------------------------------------------------------------------</code></li>
<li class="missed"><code>def get_paginator_data( page, pages, adjacent_pages=2 ):</code></li>
<li class="missed"><code>    startPage = max(page - adjacent_pages, 1)</code></li>
<li class="missed"><code>    if startPage &lt;= 3: startPage = 1</code></li>
<li class="missed"><code>    endPage = page + adjacent_pages + 1</code></li>
<li class="missed"><code>    if endPage &gt;= pages - 1: endPage = pages + 1</code></li>
<li class="missed"><code>    page_numbers = [n for n in range(startPage, endPage) \</code></li>
<li class="ignored"><code>            if n &gt; 0 and n &lt;= pages]</code></li>
<li class="missed"><code>    if page != 1:</code></li>
<li class="missed"><code>        has_previous = True</code></li>
<li class="ignored"><code>    else:</code></li>
<li class="missed"><code>        has_previous = False</code></li>
<li class="missed"><code>    if page != pages:</code></li>
<li class="missed"><code>        has_next = True</code></li>
<li class="ignored"><code>    else:</code></li>
<li class="missed"><code>        has_next = False</code></li>
<li class="missed"><code>    if has_previous:</code></li>
<li class="missed"><code>        previous_p = page - 1</code></li>
<li class="ignored"><code>    else:</code></li>
<li class="missed"><code>        previous_p = 1</code></li>
<li class="missed"><code>    if has_next:</code></li>
<li class="missed"><code>        next_p = page + 1</code></li>
<li class="ignored"><code>    else:</code></li>
<li class="missed"><code>        next_p = pages</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    return {</code></li>
<li class="ignored"><code>        'page': page,</code></li>
<li class="ignored"><code>        'pages': pages,</code></li>
<li class="ignored"><code>        'page_numbers': page_numbers,</code></li>
<li class="ignored"><code>        'next': next_p,</code></li>
<li class="ignored"><code>        'previous': previous_p,</code></li>
<li class="ignored"><code>        'has_next': has_next,</code></li>
<li class="ignored"><code>        'has_previous': has_previous,</code></li>
<li class="ignored"><code>        'show_first': 1 not in page_numbers,</code></li>
<li class="ignored"><code>        'show_last': pages not in page_numbers,</code></li>
<li class="ignored"><code>    }</code></li>
<li class="ignored"><code>#--------------------------------------------------------------------------------------------------</code></li>
<li class="ignored"><code>#                                        STRIP_TITLE</code></li>
<li class="ignored"><code>#--------------------------------------------------------------------------------------------------</code></li>
<li class="missed"><code>def strip_title( text ):</code></li>
<li class="missed"><code>    if ( text.startswith("&lt;b&gt;") != True ):</code></li>
<li class="missed"><code>        return ""</code></li>
<li class="missed"><code>    pos = text.find("&lt;/b&gt;")</code></li>
<li class="missed"><code>    if (pos == -1):</code></li>
<li class="missed"><code>        return ""</code></li>
<li class="missed"><code>    title = text[3:pos]</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    if ( ("&gt;" in title) or ("&lt;" in title) or (len(title) &gt; 30 ) ):</code></li>
<li class="missed"><code>        return ""</code></li>
<li class="missed"><code>    return title</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>#--------------------------------------------------------------------------------------------------</code></li>
<li class="ignored"><code>#                                       DESCRIBE_ALBUM</code></li>
<li class="ignored"><code>#--------------------------------------------------------------------------------------------------</code></li>
<li class="missed"><code>def album( request , idA, page = 1):</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    page = int(page)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    if (page &lt; 1):</code></li>
<li class="missed"><code>        raise Http404</code></li>
<li class="missed"><code>    try:</code></li>
<li class="missed"><code>        album = Album.objects.get( id = idA)</code></li>
<li class="missed"><code>        al = Album.objects.all()</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        photos = []</code></li>
<li class="missed"><code>        for tag in album.tags.all():</code></li>
<li class="missed"><code>            posts = tag.posts.all()</code></li>
<li class="missed"><code>            for post in posts:</code></li>
<li class="missed"><code>                if post not in photos:</code></li>
<li class="missed"><code>                    photos.append(post)</code></li>
<li class="missed"><code>    except Album.DoesNotExist:</code></li>
<li class="missed"><code>        raise Http404</code></li>
<li class="ignored"><code>#    photos.sort(key=lambda post: post['id'])</code></li>
<li class="missed"><code>    photos.sort(reverse=True)</code></li>
<li class="missed"><code>    num_last = 10 * page</code></li>
<li class="missed"><code>    num_first = 10 * (page - 1)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    pages = int(ceil(len(photos) / 10.0))</code></li>
<li class="missed"><code>    paginator = get_paginator_data( page, pages , 2 )</code></li>
<li class="missed"><code>    photos = photos[num_first:num_last]</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    num_first = num_first + 1</code></li>
<li class="missed"><code>    num_last = num_first + len(photos) - 1</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    return render_to_response('albums.html',{'photos':photos, 'album':album , 'album_list':al, 'paginator':paginator, 'nl':num_last, 'nf':num_first})</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>#--------------------------------------------------------------------------------------------------</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>def home_page( request, page ):</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    page = int(page)</code></li>
<li class="missed"><code>    num_last = 10 * page</code></li>
<li class="missed"><code>    num_first = 10 * (page - 1)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    try:</code></li>
<li class="missed"><code>        last = Post.objects.order_by('-renew')[num_first:num_last]</code></li>
<li class="missed"><code>        al = Album.objects.all()</code></li>
<li class="missed"><code>    except Post.DoesNotExist:</code></li>
<li class="missed"><code>        raise Http404</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    num_first = num_first + 1</code></li>
<li class="missed"><code>    num_last = num_first + len(last) - 1</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    pages = int(ceil(Post.objects.count() / 10.0))</code></li>
<li class="missed"><code>    paginator = get_paginator_data( page, pages , 2 )</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    return render_to_response('index.html',{ 'last':last, 'paginator':paginator, 'nl':num_last, 'nf':num_first, 'album_list':al })</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>#-----------------------------------------------------------------------------------------------------</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>def home( request ):</code></li>
<li class="missed"><code>    refresh_db_with_new_data()</code></li>
<li class="missed"><code>    refresh_db_with_new_data()</code></li>
<li class="missed"><code>    try:</code></li>
<li class="missed"><code>        last = Post.objects.order_by('-renew')[0:10]</code></li>
<li class="missed"><code>        best_photo = get_best_photo()</code></li>
<li class="missed"><code>        al = Album.objects.all()</code></li>
<li class="missed"><code>    except Post.DoesNotExist:</code></li>
<li class="missed"><code>        raise Http404</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    page = 1</code></li>
<li class="missed"><code>    pages = int(ceil(Post.objects.count() / 10.0))</code></li>
<li class="missed"><code>    paginator = get_paginator_data( page, pages , 2 )</code></li>
<li class="missed"><code>    num_last = len(last)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    return render_to_response('index.html',{ 'last':last, 'best_photo':best_photo,'best':last[:3], 'paginator':paginator, 'nl':num_last, 'nf':1, 'album_list':al })</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>def change_albums_name(album_name):</code></li>
<li class="missed"><code>    album_name.strip()</code></li>
<li class="missed"><code>    album_name.replace(' ', '-')</code></li>
<li class="missed"><code>    return album_name</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>def order(request, idOrder):</code></li>
<li class="missed"><code>    try:</code></li>
<li class="missed"><code>        al = Album.objects.all()</code></li>
<li class="missed"><code>        orderlast = Order.objects.get(id=idOrder)</code></li>
<li class="missed"><code>        ordersall = Order.objects.filter(name=orderlast.name, adress = orderlast.adress)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    except Post.DoesNotExist:</code></li>
<li class="missed"><code>        raise Http404</code></li>
<li class="missed"><code>    return render_to_response('order.html',{ 'ordersall':ordersall , 'orderlast':orderlast, 'album_list':al })</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>def get_best_photo():</code></li>
<li class="missed"><code>    now = datetime.datetime.now()</code></li>
<li class="ignored"><code>    # retrive date time of last visit to account</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    if len(LastUpdated.objects.all()) == 0:</code></li>
<li class="missed"><code>        last_update = LastUpdated(last_visit = now, album_update = "")</code></li>
<li class="missed"><code>        last_update.save()</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    last_update = LastUpdated.objects.get(id=1)</code></li>
<li class="missed"><code>    local_last_visit = last_update.last_visit</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    photos_from_db = []</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>    # get photos from db</code></li>
<li class="missed"><code>    for el in BestPhoto.objects.all():</code></li>
<li class="missed"><code>        photos_from_db.append( el )</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    if len(photos_from_db) == 0 or abs(local_last_visit.hour - now.hour) &gt;= 3 or abs(local_last_visit.day - now.day) &gt;= 1:</code></li>
<li class="ignored"><code>        # update last visit in db</code></li>
<li class="missed"><code>        last_update.last_visit = now</code></li>
<li class="missed"><code>        last_update.save()</code></li>
<li class="missed"><code>        photos_from_db = update_best_photos()</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    return photos_from_db</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>def update_best_photos():</code></li>
<li class="missed"><code>    gd_client = gdata.photos.service.PhotosService()</code></li>
<li class="missed"><code>    gd_client.email = ACCOUNT_EMAIL</code></li>
<li class="missed"><code>    gd_client.password = ACCOUNT_PASSWORD</code></li>
<li class="missed"><code>    gd_client.ProgrammaticLogin()</code></li>
<li class="missed"><code>    temp_mass_urls = []</code></li>
<li class="missed"><code>    temp_mass_ids = []</code></li>
<li class="missed"><code>    photos_from_account = []</code></li>
<li class="missed"><code>    photos_from_db = []</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    if len(BestAlbum.objects.all()) == 0:</code></li>
<li class="missed"><code>        best_album_id = BestAlbum(album_id ="")</code></li>
<li class="missed"><code>        best_album_id.save()</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    best_album_id = BestAlbum.objects.get(id=1)</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>    # retrive datetime (type is string )of last visit to account</code></li>
<li class="missed"><code>    last_update = LastUpdated.objects.get(id=1)</code></li>
<li class="missed"><code>    local_album_update = last_update.album_update</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    update_date = 0 # best photos album's update time</code></li>
<li class="missed"><code>    act_list = []</code></li>
<li class="ignored"><code>    #last_update = 0 # best photos album's update time. It is taked from last photo info from db</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>    # get photos from db</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    albums = gd_client.GetUserFeed()</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    for el in BestPhoto.objects.all():</code></li>
<li class="missed"><code>        photos_from_db.append( el.image_id )</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>    # get photos from account</code></li>
<li class="missed"><code>    for album in albums.entry:</code></li>
<li class="missed"><code>        if album.title.text == BEST_PHOTO_ALBUM:</code></li>
<li class="ignored"><code>            # if album has updated</code></li>
<li class="ignored"><code>            #raise Exception, "update.text: %s , album_update: %s" %(album.updated.text,local_album_update)</code></li>
<li class="missed"><code>            if album.updated.text != local_album_update or album.updated.text == local_album_update:</code></li>
<li class="missed"><code>                best_album_id.album_id = album.gphoto_id.text</code></li>
<li class="missed"><code>                best_album_id.save()</code></li>
<li class="ignored"><code>                #update the album_update value in db</code></li>
<li class="missed"><code>                last_update.album_update = album.updated.text</code></li>
<li class="missed"><code>                last_update.save()</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>                photos = gd_client.GetFeed('/data/feed/api/user/%s/albumid/%s?kind=photo' % ('default', album.gphoto_id.text))</code></li>
<li class="ignored"><code>                #get all photos from account</code></li>
<li class="missed"><code>                for photo in photos.entry:</code></li>
<li class="missed"><code>                    temp_mass_urls.append(photo.content.src)</code></li>
<li class="missed"><code>                    temp_mass_ids.append(photo.gphoto_id.text)</code></li>
<li class="ignored"><code>                    #photos_from_account.append(temp_mass_account)</code></li>
<li class="ignored"><code>                    #photos_from_account.append(photo.content.src)</code></li>
<li class="ignored"><code>                    #raise Exception, "src is %s" %len(photo.content.src)</code></li>
<li class="missed"><code>                for el in BestPhoto.objects.all():</code></li>
<li class="missed"><code>                    if el.image_id not in temp_mass_ids:</code></li>
<li class="ignored"><code>                    #if el.image_url not in photos_from_account:</code></li>
<li class="missed"><code>                        el.delete()</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>    # compaire photos from account and db: if the photo from account is absent indb, then the photo is added into db</code></li>
<li class="missed"><code>    ind = 0;</code></li>
<li class="missed"><code>    for element in temp_mass_ids:</code></li>
<li class="missed"><code>        if element not in photos_from_db:</code></li>
<li class="missed"><code>            p = BestPhoto( image_url = temp_mass_urls[ind], image_id = element)</code></li>
<li class="missed"><code>            p.save()</code></li>
<li class="missed"><code>        ind = ind +1;</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    photos_from_db = []</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>   # raise Exception, "length db is %d" %len(BestPhoto.objects.all())</code></li>
<li class="missed"><code>    for el in BestPhoto.objects.all():</code></li>
<li class="ignored"><code>       # photos_from_db.append( el.image_url )</code></li>
<li class="missed"><code>        photos_from_db.append( el )</code></li>
<li class="ignored"><code>       # raise Exception, "url %s" % el.image_url</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    return photos_from_db</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
  </ol>
</div>

<div class="nav">
  <a href="frontend.templatetags.cut.html">frontend.templatetags.cut</a> &lt;&lt;
  <a href="../index.html">index</a>
  &gt;&gt; <a href="frontend.widgets.html">frontend.widgets</a>
</div>

  </body>
</html>

